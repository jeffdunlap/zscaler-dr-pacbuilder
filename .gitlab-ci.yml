stages:
  - test
  - build
  - deploy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  S3_BUCKET: "${S3_BUCKET}"
  S3_PATH: "${S3_PATH:-proxy.pac}"

cache:
  paths:
    - .cache/pip/

# --- Test stage ---

test:
  stage: test
  image: python:3.11-slim
  before_script:
    - pip install -r requirements.txt pytest
  script:
    - python3 -m pytest tests/ -v

# --- Build stage ---

build:
  stage: build
  image: node:20-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq python3 python3-pip python3-venv > /dev/null
    - python3 -m venv .venv
    - . .venv/bin/activate
    - pip install -r requirements.txt
  script:
    - . .venv/bin/activate
    - python3 pacbuilder.py --output proxy.pac
    - node -e "new Function(require('fs').readFileSync('proxy.pac', 'utf8'))"
    - echo "PAC file passed Node.js syntax validation"
  artifacts:
    paths:
      - proxy.pac
    expire_in: 30 days

# --- Deploy stage ---

deploy:
  stage: deploy
  image:
    name: amazon/aws-cli:latest
    entrypoint: [""]
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  script:
    - aws s3 cp proxy.pac "s3://${S3_BUCKET}/${S3_PATH}"
      --content-type "application/x-ns-proxy-autoconfig"
    - echo "Uploaded proxy.pac to s3://${S3_BUCKET}/${S3_PATH}"
